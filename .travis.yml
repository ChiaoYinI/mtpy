dist: trusty
sudo: required  # use VM instead of docker

language: python
python:
  - "2.7"
  # does not have headers provided, please ask https://launchpad.net/~pypy/+archive/ppa
  # maintainers to fix their pypy-dev package.
  # - "pypy"

cache: pip  # make cache for pip dependencies

env:
  - MATPLOTLIB_VERSION=2.0.2
  - MATPLOTLIB_VERSION=2.1.0

before_install:
  - sudo apt update -qq
#  - sudo apt -y install -qq libgdal-dev=2.2.2  # dependencies of dgal
  # build gdal from source as the one on ubuntu trusty is out-of-date
  - sudo apt-get install build-essential python-all-dev
  - wget http://download.osgeo.org/gdal/gdal-1.9.0.tar.gz -O /tmp/gdal-1.9.0.tar.gz
  - tar xvfz /tmp/gdal-1.9.0.tar.gz
  - pushd gdal-1.9.0 && ./configure --with-python && make && sudo make install && popd
  - export CPLUS_INCLUDE_PATH=/usr/include/gdal
  - export C_INCLUDE_PATH=/usr/include/gdal

# command to install dependencies
install:
  # manually build and install gdal
#  - pip install GDAL==$(gdal-config --version | awk -F'[.]' '{print $1"."$2}') --global-option=build_ext --global-option="-I/usr/include/gdal/"
  - pip install -q matplotlib==$MATPLOTLIB_VERSION
  - pip install -q -r requirements.txt

before_script:
  - pip install pytest-xdist  # add xdist for distributing tests
  - pip freeze  # show installed packages
#  # setting up display
#  - export DISPLAY=:99.0
#  - sh -e /etc/init.d/xvfb start
#  - sleep 3 # give xvfb some time to start
#  # install mtpy2 in dev mode
#  - pip install .

script:
  - py.test -n 4 tests/core
  - py.test tests/imaging
  - py.test -n 4 tests/modeling

matrix:
  fast_finish: true
  allow_failures:
    - env: MATPLOTLIB_VERSION=2.0.2

